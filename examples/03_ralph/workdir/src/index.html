<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>todos</title>
    <style>
        :root {
            --color-primary: #af5b5e;
            --color-primary-light: #d4a5a5;
            --color-bg: #f5f5f5;
            --color-white: #ffffff;
            --color-text: #4d4d4d;
            --color-text-light: #777777;
            --color-border: #ededed;
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-shadow-hover: rgba(0, 0, 0, 0.15);
            --color-completed: #d9d9d9;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            --transition-speed: 0.2s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: 16px;
            line-height: 1.6;
            color: var(--color-text);
            background: var(--color-bg);
            min-height: 100vh;
            padding: 20px;
        }

        .app {
            max-width: 550px;
            margin: 0 auto;
            background: var(--color-white);
            box-shadow: 0 2px 8px var(--color-shadow);
            border-radius: 8px;
            overflow: hidden;
        }

        .header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--color-border);
        }

        .header h1 {
            font-size: 48px;
            font-weight: 200;
            text-align: center;
            color: var(--color-primary);
            margin-bottom: 16px;
            letter-spacing: -1px;
        }

        .add-task-form {
            position: relative;
        }

        .add-task-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            font-family: inherit;
            border: 2px solid var(--color-border);
            border-radius: 6px;
            outline: none;
            transition: border-color var(--transition-speed);
        }

        .add-task-input:focus {
            border-color: var(--color-primary-light);
        }

        .add-task-input::placeholder {
            color: var(--color-text-light);
            opacity: 0.6;
        }

        .main {
            min-height: 200px;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-border);
            transition: background-color var(--transition-speed);
            position: relative;
            min-height: 58px;
        }

        .task-item:hover {
            background-color: #fafafa;
        }

        .task-item:hover .delete-btn {
            opacity: 1;
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            min-width: 24px;
            border: 2px solid var(--color-border);
            border-radius: 50%;
            cursor: pointer;
            margin-right: 16px;
            position: relative;
            transition: all var(--transition-speed);
            flex-shrink: 0;
        }

        .task-checkbox:hover {
            border-color: var(--color-primary-light);
        }

        .task-checkbox:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .task-checkbox.checked {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .task-checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .task-content {
            flex: 1;
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .task-label {
            flex: 1;
            cursor: pointer;
            word-wrap: break-word;
            overflow-wrap: break-word;
            user-select: none;
            transition: all var(--transition-speed);
            padding: 4px 0;
        }

        .task-item.completed .task-label {
            text-decoration: line-through;
            color: var(--color-completed);
            opacity: 0.6;
        }

        .task-edit-input {
            flex: 1;
            padding: 8px 12px;
            font-size: 16px;
            font-family: inherit;
            border: 2px solid var(--color-primary);
            border-radius: 4px;
            outline: none;
        }

        .edit-btn,
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            margin-left: 8px;
            font-size: 18px;
            color: var(--color-text-light);
            transition: all var(--transition-speed);
            border-radius: 4px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .edit-btn:hover,
        .edit-btn:focus-visible {
            color: var(--color-primary);
            background-color: #fafafa;
        }

        .delete-btn {
            opacity: 0;
            color: #cc0000;
        }

        .delete-btn:hover,
        .delete-btn:focus-visible {
            opacity: 1;
            background-color: #fff0f0;
        }

        .delete-btn:focus-visible,
        .edit-btn:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .footer {
            padding: 16px 20px;
            border-top: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .task-count {
            color: var(--color-text-light);
            font-size: 14px;
        }

        .filters {
            display: flex;
            gap: 4px;
            background-color: var(--color-bg);
            padding: 4px;
            border-radius: 6px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            color: var(--color-text);
            border-radius: 4px;
            transition: all var(--transition-speed);
            min-width: 44px;
            min-height: 44px;
        }

        .filter-btn:hover {
            background-color: white;
        }

        .filter-btn:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .filter-btn.selected {
            background-color: var(--color-primary);
            color: white;
        }

        .clear-completed-btn {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            color: var(--color-text-light);
            border-radius: 4px;
            transition: all var(--transition-speed);
            min-height: 44px;
        }

        .clear-completed-btn:hover {
            color: #cc0000;
            background-color: #fff0f0;
        }

        .clear-completed-btn:focus-visible {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        .clear-completed-btn.hidden {
            display: none;
        }

        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: var(--color-text-light);
            font-size: 18px;
        }

        .storage-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #fff3cd;
            color: #856404;
            padding: 16px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px var(--color-shadow-hover);
            max-width: 320px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .storage-warning-close {
            float: right;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            margin-left: 12px;
            color: #856404;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 36px;
            }

            .add-task-input {
                font-size: 16px;
                padding: 14px 16px;
            }

            .task-item {
                padding: 12px 16px;
            }

            .footer {
                flex-direction: column;
                align-items: stretch;
            }

            .filters {
                justify-content: center;
            }

            .task-count,
            .clear-completed-btn {
                text-align: center;
            }
        }

        @media (max-width: 320px) {
            .header h1 {
                font-size: 28px;
            }

            .filter-btn {
                padding: 8px 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>todos</h1>
            <form class="add-task-form" id="addTaskForm">
                <input
                    type="text"
                    class="add-task-input"
                    id="addTaskInput"
                    placeholder="What needs to be done?"
                    autocomplete="off"
                >
            </form>
        </header>
        <main class="main" id="main">
            <ul class="task-list" id="taskList"></ul>
        </main>
        <footer class="footer" id="footer">
            <div class="task-count" id="taskCount"></div>
            <div class="filters">
                <button class="filter-btn selected" data-filter="all">All</button>
                <button class="filter-btn" data-filter="active">Active</button>
                <button class="filter-btn" data-filter="completed">Completed</button>
            </div>
            <button class="clear-completed-btn hidden" id="clearCompletedBtn">Clear completed</button>
        </footer>
    </div>

    <script>
        // Storage Layer
        const storage = {
            STORAGE_KEY: 'todos-app-data',
            localStorageAvailable: true,

            init() {
                // Test localStorage availability
                try {
                    const testKey = '__storage_test__';
                    localStorage.setItem(testKey, 'test');
                    localStorage.removeItem(testKey);
                    this.localStorageAvailable = true;
                } catch (e) {
                    this.localStorageAvailable = false;
                    console.warn('localStorage is not available. Using in-memory storage.');
                }
            },

            load() {
                if (!this.localStorageAvailable) {
                    return [];
                }

                try {
                    const data = localStorage.getItem(this.STORAGE_KEY);
                    if (!data) {
                        return [];
                    }

                    const parsed = JSON.parse(data);

                    // Validate shape
                    if (!Array.isArray(parsed)) {
                        console.warn('Invalid data format in storage. Resetting to empty array.');
                        return [];
                    }

                    // Validate each task
                    const validTasks = parsed.filter(task => {
                        return task &&
                               typeof task.id === 'string' &&
                               typeof task.text === 'string' &&
                               typeof task.completed === 'boolean' &&
                               typeof task.createdAt === 'number';
                    });

                    if (validTasks.length !== parsed.length) {
                        console.warn('Some tasks had invalid format and were filtered out.');
                    }

                    return validTasks;
                } catch (e) {
                    console.error('Failed to load tasks from storage:', e);
                    return [];
                }
            },

            save(tasks) {
                if (!this.localStorageAvailable) {
                    return;
                }

                try {
                    const serialized = JSON.stringify(tasks);
                    localStorage.setItem(this.STORAGE_KEY, serialized);
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        this.showQuotaWarning();
                    } else {
                        console.error('Failed to save tasks to storage:', e);
                    }
                }
            },

            showQuotaWarning() {
                // Remove existing warning if present
                const existingWarning = document.querySelector('.storage-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }

                const warning = document.createElement('div');
                warning.className = 'storage-warning';
                warning.innerHTML = `
                    <button class="storage-warning-close" aria-label="Close">&times;</button>
                    <strong>Storage Full!</strong><br>
                    Your browser's storage is full. Please delete some completed tasks or clear your browser data.
                `;
                document.body.appendChild(warning);

                const closeBtn = warning.querySelector('.storage-warning-close');
                closeBtn.addEventListener('click', () => warning.remove());

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (warning.parentNode) {
                        warning.remove();
                    }
                }, 10000);
            }
        };

        // Reactive Store
        class TodoStore {
            constructor() {
                this.tasks = [];
                this.subscribers = [];
                this.init();
            }

            init() {
                storage.init();
                this.tasks = storage.load();
                this.notify();
            }

            subscribe(callback) {
                this.subscribers.push(callback);
                return () => {
                    this.subscribers = this.subscribers.filter(cb => cb !== callback);
                };
            }

            notify() {
                this.subscribers.forEach(callback => callback(this.tasks));
            }

            addTask(text) {
                const trimmed = text.trim();
                if (!trimmed) {
                    return;
                }

                const task = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2, 9),
                    text: trimmed,
                    completed: false,
                    createdAt: Date.now()
                };

                this.tasks.push(task);
                this.save();
            }

            toggleTask(id) {
                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.completed = !task.completed;
                    this.save();
                }
            }

            editTask(id, newText) {
                const trimmed = newText.trim();
                if (!trimmed) {
                    return false;
                }

                const task = this.tasks.find(t => t.id === id);
                if (task) {
                    task.text = trimmed;
                    this.save();
                    return true;
                }
                return false;
            }

            deleteTask(id) {
                this.tasks = this.tasks.filter(t => t.id !== id);
                this.save();
            }

            clearCompleted() {
                this.tasks = this.tasks.filter(t => !t.completed);
                this.save();
            }

            save() {
                storage.save(this.tasks);
                this.notify();
            }

            getTasks() {
                return this.tasks;
            }

            getActiveCount() {
                return this.tasks.filter(t => !t.completed).length;
            }

            getCompletedCount() {
                return this.tasks.filter(t => t.completed).length;
            }
        }

        // UI Controller
        class TodoUI {
            constructor(store) {
                this.store = store;
                this.currentFilter = 'all';
                this.editingTaskId = null;
                this.lastClickTime = 0;
                this.debounceDelay = 300;

                this.elements = {
                    form: document.getElementById('addTaskForm'),
                    input: document.getElementById('addTaskInput'),
                    taskList: document.getElementById('taskList'),
                    taskCount: document.getElementById('taskCount'),
                    clearCompletedBtn: document.getElementById('clearCompletedBtn'),
                    main: document.getElementById('main'),
                    footer: document.getElementById('footer')
                };

                this.init();
            }

            init() {
                // Subscribe to store changes
                this.store.subscribe(() => this.render());

                // Event listeners
                this.elements.form.addEventListener('submit', (e) => this.handleAddTask(e));
                this.elements.clearCompletedBtn.addEventListener('click', () => this.handleClearCompleted());

                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.handleFilterChange(e));
                });

                // Delegate task list events
                this.elements.taskList.addEventListener('click', (e) => this.handleTaskListClick(e));
                this.elements.taskList.addEventListener('dblclick', (e) => this.handleTaskLabelDblClick(e));
                this.elements.taskList.addEventListener('keydown', (e) => this.handleTaskListKeydown(e));
                this.elements.taskList.addEventListener('blur', (e) => this.handleEditBlur(e), true);

                // Auto-focus input
                this.elements.input.focus();

                // Initial render
                this.render();
            }

            handleAddTask(e) {
                e.preventDefault();
                const text = this.elements.input.value;
                this.store.addTask(text);
                this.elements.input.value = '';
                this.elements.input.focus();
            }

            handleTaskListClick(e) {
                const taskItem = e.target.closest('.task-item');
                if (!taskItem) return;

                const taskId = taskItem.dataset.id;

                // Handle checkbox click
                if (e.target.classList.contains('task-checkbox')) {
                    this.store.toggleTask(taskId);
                }

                // Handle delete button click
                if (e.target.closest('.delete-btn')) {
                    if (this.isDebounced()) return;
                    this.store.deleteTask(taskId);
                }

                // Handle edit button click
                if (e.target.closest('.edit-btn')) {
                    if (this.isDebounced()) return;
                    this.enterEditMode(taskItem, taskId);
                }
            }

            handleTaskLabelDblClick(e) {
                if (e.target.classList.contains('task-label')) {
                    const taskItem = e.target.closest('.task-item');
                    const taskId = taskItem.dataset.id;
                    this.enterEditMode(taskItem, taskId);
                }
            }

            handleTaskListKeydown(e) {
                if (e.target.classList.contains('task-edit-input')) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.saveEdit(e.target);
                    } else if (e.key === 'Escape') {
                        this.cancelEdit();
                    }
                }

                // Handle checkbox toggle with Space/Enter
                if (e.target.classList.contains('task-checkbox')) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const taskItem = e.target.closest('.task-item');
                        this.store.toggleTask(taskItem.dataset.id);
                    }
                }
            }

            handleEditBlur(e) {
                if (e.target.classList.contains('task-edit-input')) {
                    this.saveEdit(e.target);
                }
            }

            handleFilterChange(e) {
                const filter = e.target.dataset.filter;
                this.currentFilter = filter;

                // Update selected state
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.filter === filter);
                });

                this.render();
            }

            handleClearCompleted() {
                if (this.isDebounced()) return;
                this.store.clearCompleted();
            }

            isDebounced() {
                const now = Date.now();
                if (now - this.lastClickTime < this.debounceDelay) {
                    return true;
                }
                this.lastClickTime = now;
                return false;
            }

            enterEditMode(taskItem, taskId) {
                if (this.editingTaskId) {
                    this.cancelEdit();
                }

                const task = this.store.getTasks().find(t => t.id === taskId);
                if (!task) return;

                this.editingTaskId = taskId;
                taskItem.classList.add('editing');

                const label = taskItem.querySelector('.task-label');
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'task-edit-input';
                input.value = task.text;
                input.dataset.originalValue = task.text;

                label.replaceWith(input);
                input.focus();
                input.select();
            }

            saveEdit(input) {
                if (!this.editingTaskId) return;

                const taskItem = input.closest('.task-item');
                const taskId = this.editingTaskId;
                const newText = input.value;

                const success = this.store.editTask(taskId, newText);

                if (!success) {
                    // Revert to original value
                    this.cancelEdit();
                } else {
                    this.editingTaskId = null;
                }
            }

            cancelEdit() {
                if (!this.editingTaskId) return;

                const taskItem = document.querySelector(`.task-item[data-id="${this.editingTaskId}"]`);
                if (taskItem) {
                    const input = taskItem.querySelector('.task-edit-input');
                    if (input) {
                        const label = document.createElement('div');
                        label.className = 'task-label';
                        label.textContent = input.dataset.originalValue;
                        input.replaceWith(label);
                    }
                    taskItem.classList.remove('editing');
                }

                this.editingTaskId = null;
            }

            getFilteredTasks() {
                const tasks = this.store.getTasks();

                switch (this.currentFilter) {
                    case 'active':
                        return tasks.filter(t => !t.completed);
                    case 'completed':
                        return tasks.filter(t => t.completed);
                    default:
                        return tasks;
                }
            }

            render() {
                const tasks = this.store.getTasks();
                const filteredTasks = this.getFilteredTasks();
                const activeCount = this.store.getActiveCount();
                const completedCount = this.store.getCompletedCount();

                // Render task list
                if (filteredTasks.length === 0) {
                    this.renderEmptyState();
                } else {
                    this.renderTasks(filteredTasks);
                }

                // Update task count
                const itemText = activeCount === 1 ? 'item' : 'items';
                this.elements.taskCount.textContent = `${activeCount} ${itemText} left`;

                // Show/hide clear completed button
                this.elements.clearCompletedBtn.classList.toggle('hidden', completedCount === 0);

                // Show/hide footer
                this.elements.footer.style.display = tasks.length === 0 ? 'none' : 'flex';
            }

            renderEmptyState() {
                let message = 'Add your first task!';

                if (this.store.getTasks().length > 0) {
                    if (this.currentFilter === 'active') {
                        message = 'No active tasks';
                    } else if (this.currentFilter === 'completed') {
                        message = 'No completed tasks';
                    }
                }

                this.elements.taskList.innerHTML = `
                    <div class="empty-state">${message}</div>
                `;
            }

            renderTasks(tasks) {
                // Use DocumentFragment for better performance
                const fragment = document.createDocumentFragment();

                tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = 'task-item';
                    if (task.completed) {
                        li.classList.add('completed');
                    }
                    li.dataset.id = task.id;

                    const checkbox = document.createElement('div');
                    checkbox.className = 'task-checkbox';
                    checkbox.setAttribute('tabindex', '0');
                    checkbox.setAttribute('role', 'checkbox');
                    checkbox.setAttribute('aria-checked', task.completed);
                    if (task.completed) {
                        checkbox.classList.add('checked');
                    }

                    const content = document.createElement('div');
                    content.className = 'task-content';

                    const label = document.createElement('div');
                    label.className = 'task-label';
                    label.textContent = task.text;

                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn';
                    editBtn.innerHTML = '✎';
                    editBtn.setAttribute('aria-label', 'Edit task');
                    editBtn.setAttribute('type', 'button');

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.setAttribute('aria-label', 'Delete task');
                    deleteBtn.setAttribute('type', 'button');

                    content.appendChild(label);
                    li.appendChild(checkbox);
                    li.appendChild(content);
                    li.appendChild(editBtn);
                    li.appendChild(deleteBtn);

                    fragment.appendChild(li);
                });

                this.elements.taskList.innerHTML = '';
                this.elements.taskList.appendChild(fragment);
            }
        }

        // Initialize app
        const store = new TodoStore();
        const ui = new TodoUI(store);
    </script>
</body>
</html>
